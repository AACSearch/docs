# Ограничение скорости запросов

Ограничение скорости запросов — это важная функция безопасности в AACSearch, которая предотвращает злоупотребления, ограничивая количество запросов к API, которые клиент может сделать за определенный промежуток времени. Это руководство объясняет, как работает ограничение скорости, как обрабатывать ошибки превышения лимита и лучшие практики, чтобы ваше приложение работало в рамках этих ограничений.

## Почему ограничение скорости важно

Ограничение скорости защищает как AACSearch, так и ваше приложение, путем:

- **Предотвращения злоупотреблений**: Оно останавливает злонамеренных или неправильно настроенных клиентов от перегрузки системы чрезмерными запросами, что может ухудшить производительность для всех пользователей.
- **Обеспечения справедливого использования**: Оно гарантирует, что ни один клиент не монополизирует ресурсы, обеспечивая справедливый доступ для всех пользователей.
- **Поддержания стабильности**: Оно помогает поддерживать стабильность и надежность платформы AACSearch, контролируя объем запросов.

Каждый тарифный план AACSearch включает определенный лимит скорости, который подробно описан в вашей панели управления в разделе "Тариф и оплата". Тарифы более высокого уровня обычно предлагают более высокие лимиты для увеличенного использования.

## Как работает ограничение скорости

AACSearch реализует ограничение скорости на основе API-ключей. Каждый API-ключ связан с определенным лимитом скорости, измеряемым как количество запросов, разрешенных в минуту или в час, в зависимости от вашего тарифа.

- **Область действия лимита**: Лимиты скорости применяются ко всем конечным точкам API совокупно (например, поиск, индексация, аналитика), если не указано иное.
- **Временное окно**: Лимиты рассчитываются в скользящем временном окне. Например, если ваш лимит составляет 100 запросов в минуту, он постепенно сбрасывается по мере прохождения времени в этой минуте.
- **Идентификация**: Лимиты привязаны к вашему API-ключу, поэтому запросы от разных ключей считаются отдельно.

Когда вы превышаете свой лимит скорости, AACSearch отвечает ошибкой `429 Too Many Requests`, указывая, что вы должны подождать, прежде чем делать дополнительные запросы.

## Проверка ваших лимитов скорости

Вы можете проверить текущий лимит скорости и использование в панели управления AACSearch:

1. Войдите в [Панель управления AACSearch](https://dashboard.aacsearch.com).
2. Перейдите в "Настройки" > "API-ключи".
3. Выберите используемый API-ключ, чтобы просмотреть связанный с ним лимит скорости и текущую статистику использования.
4. Также вы можете перейти в "Тариф и оплата", чтобы увидеть общие лимиты для вашего тарифного плана.

Кроме того, ответы API включают заголовки, которые предоставляют информацию о состоянии вашего лимита скорости:

- `X-Rate-Limit-Limit`: Максимальное количество запросов, разрешенных в текущем временном окне.
- `X-Rate-Limit-Remaining`: Количество оставшихся запросов в текущем временном окне.
- `X-Rate-Limit-Reset`: Время (в секундах эпохи Unix), когда окно лимита скорости сбрасывается.

### Пример заголовков ответа

```http
HTTP/1.1 200 OK
X-Rate-Limit-Limit: 100
X-Rate-Limit-Remaining: 47
X-Rate-Limit-Reset: 1673365200
```

Эти заголовки позволяют вашему приложению программно отслеживать использование и корректировать поведение, чтобы избежать достижения лимита.

## Обработка ошибок превышения лимита скорости

Когда вы превышаете свой лимит скорости, AACSearch возвращает ошибку `429 Too Many Requests` с телом ответа в формате JSON и специальными заголовками, чтобы помочь вам справиться с ситуацией.

### Пример ответа с ошибкой

```json
{
  "error": {
    "code": 429,
    "message": "Превышен лимит скорости. Пожалуйста, подождите перед отправкой новых запросов.",
    "details": {
      "limit": 100,
      "remaining": 0,
      "reset": 1673365200
    }
  }
}
```

### Заголовки ответа для ошибок превышения лимита

- `Retry-After`: Количество секунд, которое нужно подождать перед отправкой следующего запроса. Этот заголовок включен в ответы `429`, чтобы указать, как долго вы должны ждать.

### Пример заголовков ошибки

```http
HTTP/1.1 429 Too Many Requests
X-Rate-Limit-Limit: 100
X-Rate-Limit-Remaining: 0
X-Rate-Limit-Reset: 1673365200
Retry-After: 30
```

### Стратегии обработки лимитов скорости

Чтобы элегантно обрабатывать ошибки превышения лимита в вашем приложении:

1. **Реализуйте логику повторных попыток**: Когда вы получаете ошибку `429`, проверьте заголовок `Retry-After` и подождите указанное количество секунд перед повторной попыткой запроса. Используйте экспоненциальное увеличение времени ожидания для последующих попыток, если это необходимо.
   - **Пример на JavaScript (используя Fetch API)**:
     ```javascript
     async function makeRequestWithRetry(url, options) {
       let retries = 0;
       const maxRetries = 3;
       while (retries < maxRetries) {
         try {
           const response = await fetch(url, options);
           if (response.status === 429) {
             const retryAfter = response.headers.get("Retry-After");
             const waitTime = retryAfter
               ? parseInt(retryAfter) * 1000
               : Math.pow(2, retries) * 1000;
             console.log(
               `Превышен лимит скорости. Ожидание ${waitTime / 1000} секунд...`
             );
             await new Promise((resolve) => setTimeout(resolve, waitTime));
             retries++;
             continue;
           }
           if (!response.ok)
             throw new Error(`Ошибка HTTP! Статус: ${response.status}`);
           return await response.json();
         } catch (error) {
           console.error("Запрос не выполнен:", error);
           retries++;
           if (retries === maxRetries) throw error;
           await new Promise((resolve) =>
             setTimeout(resolve, Math.pow(2, retries) * 1000)
           );
         }
       }
       throw new Error("Достигнуто максимальное количество попыток");
     }
     ```
2. **Отслеживайте использование**: Следите за заголовком `X-Rate-Limit-Remaining`, чтобы заранее замедлить или приостановить запросы по мере приближения к лимиту.
3. **Очередь запросов**: Реализуйте очередь запросов для управления операциями с большим объемом, гарантируя, что запросы отправляются с контролируемой скоростью.
4. **Пакетные операции**: Для операций, таких как индексация, используйте пакетные запросы для обновления нескольких объектов в одном вызове API, уменьшая общее количество запросов. Смотрите [API объектов](../../api/objects.md) для деталей пакетных операций.
5. **Обрабатывайте ошибки элегантно**: Отображайте понятные сообщения для пользователей, если ограничения скорости вызывают задержки, особенно в пользовательских интерфейсах, таких как поисковые интерфейсы.

## Лучшие практики для избежания ограничений скорости

Чтобы минимизировать вероятность достижения лимитов скорости и обеспечить бесперебойную работу вашего приложения:

- **Оптимизируйте использование API**:
  - Кэшируйте частые результаты поиска на вашей стороне, чтобы уменьшить избыточные вызовы API. Смотрите [Стратегии кэширования](../performance/caching.md) для советов по реализации.
  - Используйте фильтры и параметры для сужения результатов поиска вместо выполнения нескольких широких запросов. Смотрите [API поиска](../../api/search.md) для деталей параметров.
  - Пакетируйте загрузку данных или обновления, когда это возможно, чтобы минимизировать количество запросов. Смотрите [API объектов](../../api/objects.md) для пакетных операций.
- **Распределяйте нагрузку**:
  - Равномерно распределяйте запросы API во времени, а не отправляйте их всплесками. Реализуйте дросселирование в вашем приложении для контроля скорости запросов.
  - Если у вас есть несколько API-ключей (например, для разных сред или приложений), чередуйте их использование для распределения нагрузки по ключам.
- **Повысьте ваш тариф**:
  - Если ваше приложение постоянно достигает лимитов скорости из-за высокого использования, рассмотрите возможность перехода на тариф более высокого уровня с увеличенными лимитами. Проверьте доступные тарифы в [Панели управления AACSearch](https://dashboard.aacsearch.com) в разделе "Тариф и оплата".
- **Отслеживайте тенденции использования**:
  - Используйте [API аналитики](../../api/analytics.md) для отслеживания моделей использования API и выявления всплесков или неэффективностей в объеме запросов. Корректируйте логику вашего приложения на основе этих данных.

## Ограничение скорости для разных тарифов

Лимиты скорости варьируются в зависимости от вашего тарифного плана. Ниже приведен обзор типичных лимитов для разных уровней (точные лимиты могут отличаться; проверьте текущие значения в вашей панели управления):

- **Бесплатный тариф**: Ограничено до 100 запросов в минуту, подходит для тестирования или небольших проектов.
- **Стартовый тариф**: До 500 запросов в минуту, предназначен для небольших и средних приложений.
- **Профессиональный тариф**: До 2000 запросов в минуту, для растущих приложений с умеренным трафиком.
- **Корпоративный тариф**: Пользовательские лимиты в зависимости от ваших потребностей, часто более 10 000 запросов в минуту, для приложений с высоким трафиком или критически важных задач.

Чтобы запросить пользовательский лимит скорости или обсудить корпоративные варианты, свяжитесь с поддержкой через [community.aacsearch.com](https://community.aacsearch.com) или по email support@aacsearch.com.

## Устранение проблем с ограничением скорости

Если вы столкнулись с проблемами, связанными с ограничением скорости:

- **Частые ошибки `429`**: Проверьте шаблоны запросов вашего приложения. Реализуйте дросселирование или пакетирование, чтобы уменьшить частоту запросов. Проверьте, необходимо ли повышение тарифа.
- **Неожиданные лимиты**: Проверьте детали вашего тарифа и разрешения API-ключа в панели управления. Если лимиты, указанные в заголовках ответа, не соответствуют вашему тарифу, свяжитесь с поддержкой.
- **Сбои в логике повторных попыток**: Убедитесь, что ваш механизм повторных попыток учитывает заголовок `Retry-After` и включает максимальный предел попыток, чтобы предотвратить бесконечные циклы.
- **Всплески использования API**: Используйте [API аналитики](../../api/analytics.md) для выявления всплесков использования. Настройте поведение приложения или инфраструктуру для лучшего управления пиковыми нагрузками.
- **Свяжитесь с поддержкой**: Для постоянных проблем или запроса временного увеличения лимита для конкретных событий (например, запусков продуктов) обратитесь в нашу службу поддержки.

## Дополнительные ресурсы

- [Панель управления AACSearch](https://dashboard.aacsearch.com) - Отслеживайте использование лимита скорости и повышайте тариф.
- [Быстрый старт API](../../api/quickstart.md) - Быстрая справка для начала работы с интеграцией API.
- [API аналитики](../../api/analytics.md) - Отслеживайте использование API для выявления и устранения проблем с ограничением скорости.
- [API объектов](../../api/objects.md) - Узнайте о пакетных операциях для уменьшения количества запросов.
- [Стратегии кэширования](../performance/caching.md) - Реализуйте кэширование для минимизации вызовов API.
- [Форум сообщества](https://community.aacsearch.com) - Общайтесь с другими разработчиками для получения советов и решений по ограничению скорости.
